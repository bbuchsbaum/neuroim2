<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Regions of Interest • neuroim2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Regions of Interest">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">neuroim2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/clustered-neurovec.html">ClusteredNeuroVec: Parcel-aware 4D neuroimaging analysis</a></li>
    <li><a class="dropdown-item" href="../articles/ImageVolumes.html">Working with Image Volumes</a></li>
    <li><a class="dropdown-item" href="../articles/NeuroVector.html">Four dimensional neuroimaging data</a></li>
    <li><a class="dropdown-item" href="../articles/pipelines.html">Pipelines</a></li>
    <li><a class="dropdown-item" href="../articles/regionOfInterest.html">Regions of Interest</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bbuchsbaum/neuroim2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Regions of Interest</h1>
            
            <h4 data-toc-skip class="date">2025-08-31</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bbuchsbaum/neuroim2/blob/master/vignettes/regionOfInterest.Rmd" class="external-link"><code>vignettes/regionOfInterest.Rmd</code></a></small>
      <div class="d-none name"><code>regionOfInterest.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction-to-regions-of-interest">Introduction to Regions of Interest<a class="anchor" aria-label="anchor" href="#introduction-to-regions-of-interest"></a>
</h2>
<div class="section level3">
<h3 id="what-are-rois">What are ROIs?<a class="anchor" aria-label="anchor" href="#what-are-rois"></a>
</h3>
<p>Regions of Interest (ROIs) are fundamental tools in neuroimaging
analysis that allow researchers to focus on specific brain areas or
patterns. Rather than analyzing every voxel in the brain independently,
ROIs enable:</p>
<ul>
<li>
<strong>Targeted analysis</strong> of anatomically or functionally
defined brain regions</li>
<li>
<strong>Dimensionality reduction</strong> by aggregating signals
within regions</li>
<li>
<strong>Statistical power</strong> improvement through spatial
averaging</li>
<li>
<strong>Hypothesis-driven</strong> investigations of specific brain
areas</li>
</ul>
</div>
<div class="section level3">
<h3 id="roi-types-in-neuroim2">ROI Types in neuroim2<a class="anchor" aria-label="anchor" href="#roi-types-in-neuroim2"></a>
</h3>
<p>The <strong>neuroim2</strong> package provides comprehensive support
for creating and manipulating ROIs:</p>
<table class="table">
<colgroup>
<col width="23%">
<col width="23%">
<col width="30%">
<col width="23%">
</colgroup>
<thead><tr class="header">
<th>ROI Type</th>
<th>Function</th>
<th>Description</th>
<th>Use Case</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Spherical</strong></td>
<td><code><a href="../reference/spherical_roi.html">spherical_roi()</a></code></td>
<td>Sphere around a center point</td>
<td>Searchlight analysis, seed-based connectivity</td>
</tr>
<tr class="even">
<td><strong>Cuboid</strong></td>
<td><code><a href="../reference/cuboid_roi.html">cuboid_roi()</a></code></td>
<td>Rectangular box region</td>
<td>Grid-based parcellation</td>
</tr>
<tr class="odd">
<td><strong>Square</strong></td>
<td><code><a href="../reference/square_roi.html">square_roi()</a></code></td>
<td>2D square in one plane</td>
<td>Slice-based analysis</td>
</tr>
<tr class="even">
<td><strong>Clustered</strong></td>
<td><code>ClusteredNeuroVol</code></td>
<td>Parcellation-based regions</td>
<td>Atlas-based analysis</td>
</tr>
<tr class="odd">
<td><strong>Custom</strong></td>
<td><code>Kernel</code></td>
<td>Weighted regions</td>
<td>Gaussian-weighted, gradient-based</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="quick-start">Quick Start<a class="anchor" aria-label="anchor" href="#quick-start"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbuchsbaum/neuroim2" class="external-link">neuroim2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read a brain volume</span></span>
<span><span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"global_mask2.nii.gz"</span>, package<span class="op">=</span><span class="st">"neuroim2"</span><span class="op">)</span></span>
<span><span class="va">vol</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_vol.html">read_vol</a></span><span class="op">(</span><span class="va">file_name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a simple spherical ROI</span></span>
<span><span class="va">roi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"ROI contains"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">roi</span><span class="op">)</span>, <span class="st">"voxels\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ROI contains 11 voxels</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="basic-roi-operations">Basic ROI Operations<a class="anchor" aria-label="anchor" href="#basic-roi-operations"></a>
</h2>
<div class="section level3">
<h3 id="creating-a-spherical-roi">Creating a Spherical ROI<a class="anchor" aria-label="anchor" href="#creating-a-spherical-roi"></a>
</h3>
<p>Spherical ROIs are the most commonly used type in neuroimaging.
They’re particularly useful for searchlight analyses and seed-based
connectivity studies.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load an example brain volume</span></span>
<span><span class="va">file_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"global_mask2.nii.gz"</span>, package<span class="op">=</span><span class="st">"neuroim2"</span><span class="op">)</span></span>
<span><span class="va">vol</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_vol.html">read_vol</a></span><span class="op">(</span><span class="va">file_name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a spherical ROI centered at voxel coordinates [20,20,20]</span></span>
<span><span class="co"># with a 5mm radius, filling all values with 100</span></span>
<span><span class="va">sphere</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">5</span>, fill <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Examine the ROI</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of voxels in ROI:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sphere</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of voxels in ROI: 11</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"ROI dimensions:"</span>, <span class="fu"><a href="../reference/dim-methods.html">dim</a></span><span class="op">(</span><span class="va">sphere</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ROI dimensions: 11 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"All values are 100:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">sphere</span> <span class="op">==</span> <span class="fl">100</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; All values are 100: TRUE</span></span></code></pre></div>
<div class="section level4">
<h4 id="performance-note-c-vs-pure-r-implementation">Performance Note: C++ vs Pure R Implementation<a class="anchor" aria-label="anchor" href="#performance-note-c-vs-pure-r-implementation"></a>
</h4>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The spherical_roi function can use either C++ (fast) or pure R (slower)</span></span>
<span><span class="co"># C++ is the default and recommended for performance</span></span>
<span><span class="va">sphere_cpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">5</span>, use_cpp <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">sphere_r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">5</span>, use_cpp <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Both produce the same result</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="../reference/coords.html">coords</a></span><span class="op">(</span><span class="va">sphere_cpp</span><span class="op">)</span>, <span class="fu"><a href="../reference/coords.html">coords</a></span><span class="op">(</span><span class="va">sphere_r</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="creating-a-spherical-roi-around-real-world-coordinates">Creating a Spherical ROI Around Real-World Coordinates<a class="anchor" aria-label="anchor" href="#creating-a-spherical-roi-around-real-world-coordinates"></a>
</h3>
<p>Often, you’ll have coordinates in millimeter space (e.g., from
published studies) rather than voxel indices.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a real-world coordinate in mm</span></span>
<span><span class="va">rpoint</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">34</span>, <span class="op">-</span><span class="fl">28</span>, <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert real-world coordinates to voxel coordinates</span></span>
<span><span class="va">vox</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/coord_to_grid-methods.html">coord_to_grid</a></span><span class="op">(</span><span class="va">vol</span>, <span class="va">rpoint</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Real coordinate:"</span>, <span class="va">rpoint</span>, <span class="st">"-&gt; Voxel coordinate:"</span>, <span class="va">vox</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Real coordinate: -34 -28 10 -&gt; Voxel coordinate: 42.71428 24.00001 16.2027</span></span>
<span></span>
<span><span class="co"># Create spherical ROI with 10mm radius</span></span>
<span><span class="va">sphere</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="va">vox</span>, radius <span class="op">=</span> <span class="fl">10</span>, fill <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"ROI contains"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sphere</span><span class="op">)</span>, <span class="st">"voxels\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ROI contains 85 voxels</span></span>
<span></span>
<span><span class="co"># Verify the center of mass is close to our target</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/index_to_coord-methods.html">index_to_coord</a></span><span class="op">(</span><span class="va">vol</span>, <span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">sphere</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">center_of_mass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Center of mass:"</span>, <span class="va">center_of_mass</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Center of mass: -36.75 -22.75 14.8</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Original point:"</span>, <span class="va">rpoint</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original point: -34 -28 10</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="creating-multiple-spherical-rois-efficiently">Creating Multiple Spherical ROIs Efficiently<a class="anchor" aria-label="anchor" href="#creating-multiple-spherical-rois-efficiently"></a>
</h3>
<p>When creating many ROIs, use the vectorized
<code><a href="../reference/spherical_roi_set.html">spherical_roi_set()</a></code> function for better performance:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbuchsbaum/neuroim2" class="external-link">neuroim2</a></span><span class="op">)</span></span>
<span><span class="va">vol</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_vol.html">read_vol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"global_mask_v4.nii"</span>, package <span class="op">=</span> <span class="st">"neuroim2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dim-methods.html">dim</a></span><span class="op">(</span><span class="va">vol</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define multiple ROI centers</span></span>
<span><span class="va">centers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">d</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">d</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">d</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Efficient vectorized creation</span></span>
<span><span class="va">rois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi_set.html">spherical_roi_set</a></span><span class="op">(</span>bvol <span class="op">=</span> <span class="va">vol</span>, centroids <span class="op">=</span> <span class="va">centers</span>, radius <span class="op">=</span> <span class="fl">5</span>, fill <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Created"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">rois</span><span class="op">)</span>, <span class="st">"ROIs\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Created 3 ROIs</span></span>
<span></span>
<span><span class="co"># Compare with loop approach (slower but equivalent)</span></span>
<span><span class="va">rois2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">centers</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="va">centers</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="fl">5</span>, fill <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Loop method also created"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">rois2</span><span class="op">)</span>, <span class="st">"ROIs\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loop method also created 3 ROIs</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="creating-cuboid-and-square-rois">Creating Cuboid and Square ROIs<a class="anchor" aria-label="anchor" href="#creating-cuboid-and-square-rois"></a>
</h3>
<div class="section level4">
<h4 id="cuboid-rois-3d-boxes">Cuboid ROIs (3D boxes)<a class="anchor" aria-label="anchor" href="#cuboid-rois-3d-boxes"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a cuboid ROI - a 3D rectangular box</span></span>
<span><span class="va">sp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NeuroSpace.html">NeuroSpace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a 7x7x7 cube (surround=3 means 3 voxels on each side of center)</span></span>
<span><span class="va">cube</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cuboid_roi.html">cuboid_roi</a></span><span class="op">(</span><span class="va">sp1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>, surround <span class="op">=</span> <span class="fl">3</span>, fill <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cuboid ROI contains"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cube</span><span class="op">)</span>, <span class="st">"voxels\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Cuboid ROI contains 343 voxels</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"All values are 5:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">cube</span> <span class="op">==</span> <span class="fl">5</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; All values are 5: TRUE</span></span>
<span></span>
<span><span class="co"># Get the coordinates</span></span>
<span><span class="va">vox_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/coords.html">coords</a></span><span class="op">(</span><span class="va">cube</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Coordinate ranges:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Coordinate ranges:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  X:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">vox_coords</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   X: 7 13</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Y:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">vox_coords</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Y: 7 13</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Z:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">vox_coords</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Z: 7 13</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="square-rois-2d-in-3d-space">Square ROIs (2D in 3D space)<a class="anchor" aria-label="anchor" href="#square-rois-2d-in-3d-space"></a>
</h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a square ROI - a 2D square fixed in one dimension</span></span>
<span><span class="va">sp1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NeuroSpace.html">NeuroSpace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a 5x5 square in the z=10 plane (fixdim=3 fixes the z dimension)</span></span>
<span><span class="va">square</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/square_roi.html">square_roi</a></span><span class="op">(</span><span class="va">sp1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>, surround <span class="op">=</span> <span class="fl">2</span>, fill <span class="op">=</span> <span class="fl">3</span>, fixdim <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Square ROI contains"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">square</span><span class="op">)</span>, <span class="st">"voxels (should be 25)\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Square ROI contains 25 voxels (should be 25)</span></span>
<span></span>
<span><span class="co"># Verify it's planar</span></span>
<span><span class="va">vox_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/coords.html">coords</a></span><span class="op">(</span><span class="va">square</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"All z-coordinates are the same:"</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">vox_coords</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; All z-coordinates are the same: TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Z-plane:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">vox_coords</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Z-plane: 10</span></span></code></pre></div>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="working-with-roi-data">Working with ROI Data<a class="anchor" aria-label="anchor" href="#working-with-roi-data"></a>
</h2>
<div class="section level3">
<h3 id="converting-rois-to-sparse-volumes">Converting ROIs to Sparse Volumes<a class="anchor" aria-label="anchor" href="#converting-rois-to-sparse-volumes"></a>
</h3>
<p>Sparse volumes are memory-efficient representations that only store
non-zero values:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a spherical ROI</span></span>
<span><span class="va">sphere</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">10</span>, fill <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"ROI contains"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sphere</span><span class="op">)</span>, <span class="st">"voxels\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ROI contains 85 voxels</span></span>
<span></span>
<span><span class="co"># Convert to SparseNeuroVol - memory efficient storage</span></span>
<span><span class="co"># Prefer the provided coercion helper</span></span>
<span><span class="va">sparsevol</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as.sparse.html">as.sparse</a></span><span class="op">(</span><span class="va">sphere</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Verify properties</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Sum of values match:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sparsevol</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">sphere</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Sum of values match: TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Dimensions match:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="../reference/dim-methods.html">dim</a></span><span class="op">(</span><span class="va">sparsevol</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="../reference/dim-methods.html">dim</a></span><span class="op">(</span><span class="va">vol</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Dimensions match: TRUE</span></span>
<span></span>
<span><span class="co"># Memory comparison</span></span>
<span><span class="va">roi_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sphere</span><span class="op">)</span></span>
<span><span class="va">sparse_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sparsevol</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Memory usage - ROI:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">roi_size</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Memory usage - ROI: 9.8 Kb</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Memory usage - Sparse:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">sparse_size</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Memory usage - Sparse: 8.9 Kb</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="extracting-time-series-from-rois-4d-data">Extracting Time-Series from ROIs (4D Data)<a class="anchor" aria-label="anchor" href="#extracting-time-series-from-rois-4d-data"></a>
</h3>
<p>ROIs are particularly useful for extracting time-series from 4D
functional data:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load a 4D dataset (using mask file as example - normally this would be fMRI data)</span></span>
<span><span class="va">vec4d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_vec.html">read_vec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"global_mask_v4.nii"</span>, package <span class="op">=</span> <span class="st">"neuroim2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"4D data dimensions:"</span>, <span class="fu"><a href="../reference/dim-methods.html">dim</a></span><span class="op">(</span><span class="va">vec4d</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; 4D data dimensions: 64 64 25 4</span></span>
<span></span>
<span><span class="co"># Create an ROI</span></span>
<span><span class="va">roi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">12</span>, <span class="fl">12</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract time-series from the ROI</span></span>
<span><span class="va">roi_series</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/series_roi.html">series_roi</a></span><span class="op">(</span><span class="va">vec4d</span>, <span class="va">roi</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"ROI time-series dimensions:"</span>, <span class="fu"><a href="../reference/dim-methods.html">dim</a></span><span class="op">(</span><span class="va">roi_series</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ROI time-series dimensions: 19 3</span></span>
<span></span>
<span><span class="co"># Get mean time-series across ROI (average across voxels)</span></span>
<span><span class="va">mat_roi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/values-methods.html">values</a></span><span class="op">(</span><span class="va">roi_series</span><span class="op">)</span>      <span class="co"># T x N matrix</span></span>
<span><span class="va">mean_series</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">mat_roi</span><span class="op">)</span>   <span class="co"># length equals time dimension</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Mean time-series length:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mean_series</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Mean time-series length: 4</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-roivec-for-4d-roi-data">Using ROIVec for 4D ROI Data<a class="anchor" aria-label="anchor" href="#using-roivec-for-4d-roi-data"></a>
</h3>
<p>The <code>ROIVec</code> class is designed for efficient storage of 4D
ROI data:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a 4D NeuroSpace</span></span>
<span><span class="va">vspace</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NeuroSpace.html">NeuroSpace</a></span><span class="op">(</span>dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span>, spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define ROI coordinates</span></span>
<span><span class="va">roi_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span>, <span class="fl">6</span>,<span class="fl">5</span>,<span class="fl">5</span>, <span class="fl">5</span>,<span class="fl">6</span>,<span class="fl">5</span>, <span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">6</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create synthetic time-series data for each voxel</span></span>
<span><span class="va">n_timepoints</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">n_voxels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">roi_coords</span><span class="op">)</span></span>
<span><span class="va">roi_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_timepoints</span> <span class="op">*</span> <span class="va">n_voxels</span><span class="op">)</span>, </span>
<span>                   nrow <span class="op">=</span> <span class="va">n_timepoints</span>, ncol <span class="op">=</span> <span class="va">n_voxels</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create ROIVec object</span></span>
<span><span class="va">roi_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ROIVec.html">ROIVec</a></span><span class="op">(</span><span class="va">vspace</span>, <span class="va">roi_coords</span>, <span class="va">roi_data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"ROIVec created with"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">roi_coords</span><span class="op">)</span>, <span class="st">"voxels and"</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">roi_data</span><span class="op">)</span>, <span class="st">"timepoints\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ROIVec created with 4 voxels and 20 timepoints</span></span>
<span></span>
<span><span class="co"># Access as matrix of values (T x N)</span></span>
<span><span class="va">roi_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/values-methods.html">values</a></span><span class="op">(</span><span class="va">roi_vec</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matrix dimensions (T x N):"</span>, <span class="fu"><a href="../reference/dim-methods.html">dim</a></span><span class="op">(</span><span class="va">roi_matrix</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Matrix dimensions (T x N): 20 4</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="searchlight-analyses">Searchlight Analyses<a class="anchor" aria-label="anchor" href="#searchlight-analyses"></a>
</h2>
<p>Searchlight analysis is a powerful technique for multivariate pattern
analysis that examines local neighborhoods throughout the brain.</p>
<div class="section level3">
<h3 id="basic-searchlight">Basic Searchlight<a class="anchor" aria-label="anchor" href="#basic-searchlight"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate exhaustive searchlight covering all voxels</span></span>
<span><span class="va">slist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/searchlight.html">searchlight</a></span><span class="op">(</span><span class="va">vol</span>, eager <span class="op">=</span> <span class="cn">TRUE</span>, radius <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of searchlights:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">slist</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of searchlights: 29532</span></span>
<span></span>
<span><span class="co"># Compute mean value in each searchlight</span></span>
<span><span class="va">searchlight_means</span> <span class="op">&lt;-</span> <span class="va">slist</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">vol</span><span class="op">[</span><span class="fu"><a href="../reference/coords.html">coords</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Computed means for"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">searchlight_means</span><span class="op">)</span>, <span class="st">"searchlights\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Computed means for 29532 searchlights</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Mean range:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">searchlight_means</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Mean range: 0.02040816 1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="randomized-searchlight">Randomized Searchlight<a class="anchor" aria-label="anchor" href="#randomized-searchlight"></a>
</h3>
<p>Randomized searchlight samples voxels without replacement, ensuring
coverage while reducing redundancy:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Randomized searchlight - each voxel appears in at least one searchlight</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>  <span class="co"># For reproducibility</span></span>
<span><span class="va">random_lights</span> <span class="op">&lt;-</span> <span class="va">vol</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/random_searchlight.html">random_searchlight</a></span><span class="op">(</span>radius <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">vol</span><span class="op">[</span><span class="fu"><a href="../reference/coords.html">coords</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Random searchlight count:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">random_lights</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Random searchlight count: 2082</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="clustered-searchlight">Clustered Searchlight<a class="anchor" aria-label="anchor" href="#clustered-searchlight"></a>
</h3>
<p>Use anatomical or functional parcellations to define ROIs:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a clustering over the voxel space</span></span>
<span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/index_to_coord-methods.html">index_to_coord</a></span><span class="op">(</span><span class="va">vol</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">vol</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">kres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">grid</span>, centers <span class="op">=</span> <span class="fl">50</span>, iter.max <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create ClusteredNeuroVol</span></span>
<span><span class="va">kvol</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ClusteredNeuroVol-class.html">ClusteredNeuroVol</a></span><span class="op">(</span><span class="va">vol</span>, <span class="va">kres</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Created"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">kres</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span>, <span class="st">"clusters\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Created 50 clusters</span></span>
<span></span>
<span><span class="co"># Run clustered searchlight</span></span>
<span><span class="va">cluster_means</span> <span class="op">&lt;-</span> <span class="va">vol</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/clustered_searchlight.html">clustered_searchlight</a></span><span class="op">(</span>cvol <span class="op">=</span> <span class="va">kvol</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">vol</span><span class="op">[</span><span class="fu"><a href="../reference/coords.html">coords</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cluster mean range:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">cluster_means</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Cluster mean range: 1 1</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="image-patches">Image Patches<a class="anchor" aria-label="anchor" href="#image-patches"></a>
</h2>
<p>Patches are regular, fixed-size regions that tile the image space,
useful for convolutional approaches:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create 3x3x1 patches covering the volume</span></span>
<span><span class="va">pset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/patch_set.html">patch_set</a></span><span class="op">(</span><span class="va">vol</span>, dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of patches:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pset</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of patches: 102400</span></span>
<span></span>
<span><span class="co"># Compute statistics for each patch</span></span>
<span><span class="va">patch_means</span> <span class="op">&lt;-</span> <span class="va">pset</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Patch mean range:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">patch_means</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Patch mean range: 0 1</span></span>
<span></span>
<span><span class="co"># Restrict patches to masked regions only</span></span>
<span><span class="va">pset_masked</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/patch_set.html">patch_set</a></span><span class="op">(</span><span class="va">vol</span>, dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>, mask <span class="op">=</span> <span class="fu"><a href="../reference/as.logical-methods.html">as.logical</a></span><span class="op">(</span><span class="va">vol</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Masked patches:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pset_masked</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Masked patches: 29532</span></span>
<span></span>
<span><span class="co"># Patches are guaranteed to be equal size (padded at edges if needed)</span></span>
<span><span class="va">patch_sizes</span> <span class="op">&lt;-</span> <span class="va">pset_masked</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_int</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"All patches same size:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">patch_sizes</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; All patches same size: TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Patch size:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">patch_sizes</span><span class="op">)</span>, <span class="st">"voxels\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Patch size: 18 voxels</span></span></code></pre></div>
<hr>
</div>
<div class="section level2">
<h2 id="advanced-roi-techniques">Advanced ROI Techniques<a class="anchor" aria-label="anchor" href="#advanced-roi-techniques"></a>
</h2>
<div class="section level3">
<h3 id="custom-weighted-rois-with-kernels">Custom Weighted ROIs with Kernels<a class="anchor" aria-label="anchor" href="#custom-weighted-rois-with-kernels"></a>
</h3>
<p>Create Gaussian-weighted or other custom-shaped ROIs:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a Gaussian kernel for weighted ROI</span></span>
<span><span class="va">kern_dim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>  <span class="co"># 5x5x5 kernel</span></span>
<span><span class="va">voxel_dim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>  <span class="co"># 1mm isotropic voxels</span></span>
<span></span>
<span><span class="co"># Create Gaussian-weighted kernel</span></span>
<span><span class="va">gauss_kernel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Kernel.html">Kernel</a></span><span class="op">(</span>kerndim <span class="op">=</span> <span class="va">kern_dim</span>, vdim <span class="op">=</span> <span class="va">voxel_dim</span>, </span>
<span>                       FUN <span class="op">=</span> <span class="va">dnorm</span>, sd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Embed kernel at a specific location</span></span>
<span><span class="va">embedded</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/embed_kernel-methods.html">embed_kernel</a></span><span class="op">(</span><span class="va">gauss_kernel</span>, <span class="fu"><a href="../reference/space-methods.html">space</a></span><span class="op">(</span><span class="va">vol</span><span class="op">)</span>, </span>
<span>                         center_voxel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Kernel weights sum to:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">embedded</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Kernel weights sum to: 1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="working-with-clusteredneurovec-for-parcellated-data">Working with ClusteredNeuroVec for Parcellated Data<a class="anchor" aria-label="anchor" href="#working-with-clusteredneurovec-for-parcellated-data"></a>
</h3>
<p>Efficiently handle parcellated 4D data where voxels are grouped into
regions:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create synthetic 4D data</span></span>
<span><span class="va">sp4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NeuroSpace.html">NeuroSpace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">arr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">*</span><span class="fl">10</span><span class="op">*</span><span class="fl">10</span><span class="op">*</span><span class="fl">20</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NeuroVec-class.html">NeuroVec</a></span><span class="op">(</span><span class="va">arr</span>, <span class="va">sp4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create mask for central region</span></span>
<span><span class="va">sp3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NeuroSpace.html">NeuroSpace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mask_arr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">FALSE</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mask_arr</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">8</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">8</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LogicalNeuroVol-class.html">LogicalNeuroVol</a></span><span class="op">(</span><span class="va">mask_arr</span>, <span class="va">sp3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assign voxels to 5 random clusters</span></span>
<span><span class="va">n_voxels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">mask_arr</span><span class="op">)</span></span>
<span><span class="va">clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="va">n_voxels</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">cvol</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ClusteredNeuroVol-class.html">ClusteredNeuroVol</a></span><span class="op">(</span><span class="va">mask</span>, <span class="va">clusters</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create clustered representation - one time-series per cluster</span></span>
<span><span class="va">cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ClusteredNeuroVec.html">ClusteredNeuroVec</a></span><span class="op">(</span><span class="va">vec</span>, <span class="va">cvol</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Access cluster time-series efficiently</span></span>
<span><span class="va">cluster_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">cv</span><span class="op">)</span>  <span class="co"># T x K matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cluster matrix dimensions:"</span>, <span class="fu"><a href="../reference/dim-methods.html">dim</a></span><span class="op">(</span><span class="va">cluster_matrix</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Cluster matrix dimensions: 20 5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"("</span>, <span class="fu"><a href="../reference/dim-methods.html">dim</a></span><span class="op">(</span><span class="va">cluster_matrix</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"timepoints x"</span>, </span>
<span>    <span class="fu"><a href="../reference/dim-methods.html">dim</a></span><span class="op">(</span><span class="va">cluster_matrix</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"clusters)\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ( 20 timepoints x 5 clusters)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="roi-set-operations">ROI Set Operations<a class="anchor" aria-label="anchor" href="#roi-set-operations"></a>
</h3>
<p>Combine and manipulate multiple ROIs:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create two overlapping spherical ROIs</span></span>
<span><span class="va">roi1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">6</span>, fill <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">roi2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">23</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>, radius <span class="op">=</span> <span class="fl">6</span>, fill <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get indices for set operations</span></span>
<span><span class="va">idx1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">roi1</span><span class="op">)</span></span>
<span><span class="va">idx2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">roi2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Intersection - voxels in both ROIs</span></span>
<span><span class="va">intersection_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">idx1</span>, <span class="va">idx2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Intersection:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">intersection_idx</span><span class="op">)</span>, <span class="st">"voxels\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Intersection: 0 voxels</span></span>
<span></span>
<span><span class="co"># Union - voxels in either ROI</span></span>
<span><span class="va">union_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">union</a></span><span class="op">(</span><span class="va">idx1</span>, <span class="va">idx2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Union:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">union_idx</span><span class="op">)</span>, <span class="st">"voxels\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Union: 38 voxels</span></span>
<span></span>
<span><span class="co"># Difference - voxels in roi1 but not roi2</span></span>
<span><span class="va">diff_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">idx1</span>, <span class="va">idx2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Difference (roi1 - roi2):"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">diff_idx</span><span class="op">)</span>, <span class="st">"voxels\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Difference (roi1 - roi2): 19 voxels</span></span>
<span></span>
<span><span class="co"># Calculate overlap percentage</span></span>
<span><span class="va">overlap_pct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">intersection_idx</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">union_idx</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Overlap:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">overlap_pct</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Overlap: 0 %</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="best-practices-and-performance">Best Practices and Performance<a class="anchor" aria-label="anchor" href="#best-practices-and-performance"></a>
</h2>
<div class="section level3">
<h3 id="memory-management">Memory Management<a class="anchor" aria-label="anchor" href="#memory-management"></a>
</h3>
<p>When working with many ROIs, consider memory usage:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare memory usage of different ROI storage methods</span></span>
<span><span class="va">n_rois</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">centers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_rois</span> <span class="op">*</span> <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">15</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Method 1: List of ROI objects (flexible but more memory)</span></span>
<span>  <span class="va">roi_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">centers</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="va">centers</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, radius <span class="op">=</span> <span class="fl">6</span>, fill <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Method 2: Single sparse volume with labeled regions (ensure increasing indices)</span></span>
<span><span class="va">all_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">all_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">centers</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">roi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="va">centers</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, radius <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span>  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">roi</span><span class="op">)</span></span>
<span>  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">idx</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">all_indices</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">idx</span></span>
<span>  <span class="va">all_labels</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">idx</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">idx_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">all_indices</span><span class="op">)</span></span>
<span><span class="va">lab_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">all_labels</span><span class="op">)</span></span>
<span><span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">idx_all</span><span class="op">)</span></span>
<span><span class="va">idx_all</span> <span class="op">&lt;-</span> <span class="va">idx_all</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span></span>
<span><span class="va">lab_all</span> <span class="op">&lt;-</span> <span class="va">lab_all</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span></span>
<span><span class="co"># Ensure strictly increasing indices by removing duplicates</span></span>
<span><span class="va">keep</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">duplicated</a></span><span class="op">(</span><span class="va">idx_all</span><span class="op">)</span></span>
<span><span class="va">idx_all</span> <span class="op">&lt;-</span> <span class="va">idx_all</span><span class="op">[</span><span class="va">keep</span><span class="op">]</span></span>
<span><span class="va">lab_all</span> <span class="op">&lt;-</span> <span class="va">lab_all</span><span class="op">[</span><span class="va">keep</span><span class="op">]</span></span>
<span><span class="va">combined_sparse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SparseNeuroVol-class.html">SparseNeuroVol</a></span><span class="op">(</span><span class="va">lab_all</span>, <span class="fu"><a href="../reference/space-methods.html">space</a></span><span class="op">(</span><span class="va">vol</span><span class="op">)</span>, indices <span class="op">=</span> <span class="va">idx_all</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Memory usage:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Memory usage:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  ROI list:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">roi_list</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   ROI list: 771.1 Kb</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Sparse combined:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">combined_sparse</span><span class="op">)</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Sparse combined: 23.7 Kb</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="choosing-roi-sizes">Choosing ROI Sizes<a class="anchor" aria-label="anchor" href="#choosing-roi-sizes"></a>
</h3>
<p>Guidelines for selecting appropriate ROI sizes:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstrate effect of ROI size on coverage and overlap</span></span>
<span><span class="va">radii</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">8</span>, <span class="fl">10</span>, <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">coverage_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  radius <span class="op">=</span> <span class="va">radii</span>,</span>
<span>  n_voxels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">radii</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  pct_overlap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">radii</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">center1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">center2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span>  <span class="co"># 5 voxels apart</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">radii</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">roi1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="va">center1</span>, radius <span class="op">=</span> <span class="va">radii</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">roi2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="va">center2</span>, radius <span class="op">=</span> <span class="va">radii</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">coverage_stats</span><span class="op">$</span><span class="va">n_voxels</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">roi1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">overlap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">roi1</span><span class="op">)</span>, <span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">roi2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">union</a></span><span class="op">(</span><span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">roi1</span><span class="op">)</span>, <span class="fu"><a href="../reference/indices.html">indices</a></span><span class="op">(</span><span class="va">roi2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">coverage_stats</span><span class="op">$</span><span class="va">pct_overlap</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">overlap</span> <span class="op">/</span> <span class="va">total</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">coverage_stats</span><span class="op">)</span></span>
<span><span class="co">#&gt;   radius n_voxels pct_overlap</span></span>
<span><span class="co">#&gt; 1      6       19    0.000000</span></span>
<span><span class="co">#&gt; 2      8       49    0.000000</span></span>
<span><span class="co">#&gt; 3     10       85    0.000000</span></span>
<span><span class="co">#&gt; 4     12      163    5.844156</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="parallel-processing-tips">Parallel Processing Tips<a class="anchor" aria-label="anchor" href="#parallel-processing-tips"></a>
</h3>
<p>For large-scale ROI analyses, consider parallel processing:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example of parallel searchlight analysis (not run in vignette)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach" class="external-link">foreach</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Setup parallel backend</span></span>
<span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Parallel searchlight computation</span></span>
<span><span class="va">searchlight_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span><span class="op">(</span>roi <span class="op">=</span> <span class="va">searchlight_list</span>, </span>
<span>                               .packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"neuroim2"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">%dopar%</a></span> <span class="op">{</span></span>
<span>  <span class="co"># Your analysis function here</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="fu"><a href="../reference/coords.html">coords</a></span><span class="op">(</span><span class="va">roi</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Clean up</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting-and-tips">Troubleshooting and Tips<a class="anchor" aria-label="anchor" href="#troubleshooting-and-tips"></a>
</h2>
<div class="section level3">
<h3 id="common-issues-and-solutions">Common Issues and Solutions<a class="anchor" aria-label="anchor" href="#common-issues-and-solutions"></a>
</h3>
<div class="section level4">
<h4 id="issue-roi-extends-outside-brain-mask">Issue: ROI extends outside brain mask<a class="anchor" aria-label="anchor" href="#issue-roi-extends-outside-brain-mask"></a>
</h4>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Problem: ROI at edge of brain</span></span>
<span><span class="va">edge_vox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>  <span class="co"># Near edge of volume</span></span>
<span></span>
<span><span class="co"># Solution 1: Use nonzero=TRUE to keep only mask voxels</span></span>
<span><span class="va">roi_filtered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spherical_roi.html">spherical_roi</a></span><span class="op">(</span><span class="va">vol</span>, <span class="va">edge_vox</span>, radius <span class="op">=</span> <span class="fl">5</span>, nonzero <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Filtered ROI size:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">roi_filtered</span><span class="op">)</span>, <span class="st">"voxels\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Filtered ROI size: 0 voxels</span></span>
<span></span>
<span><span class="co"># Solution 2: Check if ROI is valid before analysis</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">roi_filtered</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Warning: ROI too small for reliable analysis\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Warning: ROI too small for reliable analysis</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="issue-different-coordinate-systems">Issue: Different coordinate systems<a class="anchor" aria-label="anchor" href="#issue-different-coordinate-systems"></a>
</h4>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Always verify your coordinate system</span></span>
<span><span class="va">test_coord_mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">34</span>, <span class="op">-</span><span class="fl">28</span>, <span class="fl">10</span><span class="op">)</span>  <span class="co"># MNI coordinates</span></span>
<span><span class="va">test_coord_vox</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/coord_to_grid-methods.html">coord_to_grid</a></span><span class="op">(</span><span class="va">vol</span>, <span class="va">test_coord_mm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Verify round-trip conversion</span></span>
<span><span class="va">back_to_mm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/grid_to_coord-methods.html">grid_to_coord</a></span><span class="op">(</span><span class="va">vol</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">test_coord_vox</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Original (mm):"</span>, <span class="va">test_coord_mm</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original (mm): -34 -28 10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Voxel:"</span>, <span class="va">test_coord_vox</span>, <span class="st">"\n"</span><span class="op">)</span>  </span>
<span><span class="co">#&gt; Voxel: 42.71428 23.85711 16.1892</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Back to mm:"</span>, <span class="va">back_to_mm</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Back to mm: -33.99997 -28.00012 10.00004</span></span></code></pre></div>
<hr>
</div>
</div>
</div>
<div class="section level2">
<h2 id="see-also">See Also<a class="anchor" aria-label="anchor" href="#see-also"></a>
</h2>
<p>For related functionality, see these other vignettes and help
pages:</p>
<ul>
<li>
<code><a href="../articles/NeuroVector.html">vignette("NeuroVector")</a></code> - Working with 4D neuroimaging
data</li>
<li>
<code><a href="../reference/read_vec.html">?read_vec</a></code> and <code><a href="../reference/read_vol.html">?read_vol</a></code> - Reading
neuroimaging files</li>
<li>
<code><a href="../reference/NeuroSpace.html">?NeuroSpace</a></code> - Understanding coordinate systems and
spaces</li>
<li>
<code><a href="../reference/ClusteredNeuroVol-class.html">?ClusteredNeuroVol</a></code> - Parcellation-based analyses</li>
<li>
<code><a href="../reference/SparseNeuroVol-class.html">?SparseNeuroVol</a></code> - Memory-efficient sparse
representations</li>
<li>
<code><a href="../reference/series-methods.html">?series</a></code> and <code><a href="../reference/series_roi.html">?series_roi</a></code> - Time-series
extraction</li>
</ul>
<p>For the complete list of ROI-related functions:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/help.html" class="external-link">help</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"neuroim2"</span>, topic <span class="op">=</span> <span class="st">"roi"</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bradley R Buchsbaum.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
