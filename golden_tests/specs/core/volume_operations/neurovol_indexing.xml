<?xml version="1.0" encoding="UTF-8"?>
<golden_test xmlns="http://golden-tests.org/schema">
  <metadata>
    <id>neurovol_indexing_subsetting</id>
    <version>1.0</version>
    <description>Test NeuroVol indexing and subsetting operations</description>
    <tags>
      <tag>volume_operations</tag>
      <tag>indexing</tag>
      <tag>subsetting</tag>
      <tag>core</tag>
    </tags>
  </metadata>
  
  <semantic_description>
    <purpose>
      Validate various indexing and subsetting operations on NeuroVol objects,
      including single voxel access, slice extraction, logical indexing, and
      coordinate-based selection.
    </purpose>
    <algorithm>
      1. Create a 4x4x4 NeuroVol with values 1 to 64
      2. Test single voxel indexing: vol[2, 3, 4]
      3. Test slice extraction: vol[, , 2] (all x,y at z=2)
      4. Test row extraction: vol[2, , ] (row 2 across all y,z)
      5. Test logical indexing: vol[vol > 30]
      6. Test multi-coordinate indexing with vectors
      7. Validate dimension dropping behavior
    </algorithm>
  </semantic_description>
  
  <inputs>
    <array>
      <name>test_data</name>
      <dimensions>4 4 4</dimensions>
      <values>1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64</values>
    </array>
  </inputs>
  
  <expected_outputs>
    <numeric_checks>
      <!-- Single voxel access -->
      <check>
        <type>exact_value</type>
        <name>single_voxel</name>
        <location>single_voxel</location>
        <expected>58</expected>
        <tolerance>1e-10</tolerance>
      </check>
      
      <!-- Slice extraction dimensions -->
      <check>
        <type>dimension</type>
        <name>slice_dims</name>
        <location>dim(slice_z2)</location>
        <expected>4 4</expected>
      </check>
      
      <!-- Slice values check -->
      <check>
        <type>exact_value</type>
        <name>slice_sum</name>
        <location>sum(slice_z2)</location>
        <expected>392</expected>
        <tolerance>1e-10</tolerance>
      </check>
      
      <!-- Row extraction dimensions -->
      <check>
        <type>dimension</type>
        <name>row_dims</name>
        <location>dim(row_x2)</location>
        <expected>4 4</expected>
      </check>
      
      <!-- Row specific values -->
      <check>
        <type>exact_value</type>
        <name>row_first_value</name>
        <location>row_x2[1,1]</location>
        <expected>2</expected>
        <tolerance>1e-10</tolerance>
      </check>
      
      <check>
        <type>exact_value</type>
        <name>row_last_value</name>
        <location>row_x2[4,4]</location>
        <expected>62</expected>
        <tolerance>1e-10</tolerance>
      </check>
      
      <!-- Logical indexing -->
      <check>
        <type>exact_value</type>
        <name>logical_count</name>
        <location>length(values_gt30)</location>
        <expected>34</expected>
      </check>
      
      <check>
        <type>exact_value</type>
        <name>logical_min</name>
        <location>min(values_gt30)</location>
        <expected>31</expected>
        <tolerance>1e-10</tolerance>
      </check>
      
      <check>
        <type>exact_value</type>
        <name>logical_max</name>
        <location>max(values_gt30)</location>
        <expected>64</expected>
        <tolerance>1e-10</tolerance>
      </check>
      
      <!-- Multi-index selection -->
      <check>
        <type>exact_value</type>
        <name>multi_index_length</name>
        <location>length(multi_vals)</location>
        <expected>3</expected>
      </check>
      
      <check>
        <type>exact_value</type>
        <name>multi_index_values</name>
        <location>multi_vals</location>
        <expected>1 26 64</expected>
        <tolerance>1e-10</tolerance>
      </check>
      
      <!-- Sub-volume extraction -->
      <check>
        <type>dimension</type>
        <name>subvol_dims</name>
        <location>dim(subvol)</location>
        <expected>2 2 2</expected>
      </check>
      
      <check>
        <type>exact_value</type>
        <name>subvol_sum</name>
        <location>sum(subvol)</location>
        <expected>260</expected>
        <tolerance>1e-10</tolerance>
      </check>
    </numeric_checks>
  </expected_outputs>
  
  <implementations>
    <R><![CDATA[
library(neuroim2)

# Create test volume
space <- NeuroSpace(dim = c(4, 4, 4), 
                    spacing = c(1, 1, 1), 
                    origin = c(0, 0, 0))
test_data <- array(1:64, dim = c(4, 4, 4))
vol <- NeuroVol(test_data, space)

# Single voxel access
single_voxel <- vol[2, 3, 4]

# Slice extraction (z = 2)
slice_z2 <- vol[, , 2]

# Row extraction (x = 2)
row_x2 <- vol[2, , ]

# Logical indexing
values_gt30 <- vol[vol > 30]

# Multi-index selection
idx_x <- c(1, 2, 4)
idx_y <- c(1, 3, 4)
idx_z <- c(1, 2, 4)
multi_vals <- numeric(3)
for (i in 1:3) {
  multi_vals[i] <- vol[idx_x[i], idx_y[i], idx_z[i]]
}

# Sub-volume extraction
subvol <- vol[2:3, 2:3, 2:3]
]]></R>
  </implementations>
  
  <propagation_status>
    <implementation lang="R" status="complete" date="2025-01-06"/>
    <implementation lang="Python" status="pending"/>
    <implementation lang="Rust" status="pending"/>
  </propagation_status>
</golden_test>