<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Regions of Interest • neuroim2</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Regions of Interest">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">neuroim2</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ImageVolumes.html">Working with Image Volumes</a>
    </li>
    <li>
      <a href="../articles/NeuroVector.html">Four dimensional neuroimaging data</a>
    </li>
    <li>
      <a href="../articles/neuroim.html">The neuroim2 package</a>
    </li>
    <li>
      <a href="../articles/pipelines.html">Pipelines</a>
    </li>
    <li>
      <a href="../articles/regionOfInterest.html">Regions of Interest</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Regions of Interest</h1>
            
            <h4 class="date">2019-02-08</h4>
      
      
      <div class="hidden name"><code>regionOfInterest.Rmd</code></div>

    </div>

    
    
<div id="regions-of-interest" class="section level1">
<h1 class="hasAnchor">
<a href="#regions-of-interest" class="anchor"></a>Regions of interest</h1>
<div id="creating-a-spherical-roi" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-a-spherical-roi" class="anchor"></a>Creating a spherical ROI</h2>
<p>In <strong>neuroim2</strong> there is basic support for creating regions of interest (ROI). To create a spherical ROI around a central point, we need an existing object of type <code>NeuroVol</code> or <code>NeuroSpace</code>.</p>
<p>To create a spherical region of interest with a 5mm radius around a central voxel at i=20, j=20, k=20, we first read in an image.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">      <span class="kw">library</span>(neuroim2)        
      file_name &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"global_mask.nii"</span>, <span class="dt">package=</span><span class="st">"neuroim2"</span>)
      vol &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_vol.html">read_vol</a></span>(file_name)</code></pre></div>
<p>Next, we create a spherical ROI centered around voxel coordinates [20,20,20] with a 5mm radius, filling all values in the ROI with 100.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">      sphere &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spherical_roi.html">spherical_roi</a></span>(vol, <span class="kw">c</span>(<span class="dv">20</span>,<span class="dv">20</span>,<span class="dv">20</span>), <span class="dt">radius=</span><span class="dv">5</span>, <span class="dt">fill=</span><span class="dv">100</span>)</code></pre></div>
<pre><code>#&gt; 
#&gt; 
#&gt; ROIVol 
#&gt;   Size:            11 
#&gt;   Parent Dim:      64 64 25 
#&gt;   Num Data Cols:   1 
#&gt;   Voxel Cen. Mass: 20 20 20</code></pre>
</div>
<div id="creating-a-spherical-roi-around-a-real-valued-coordinate" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-a-spherical-roi-around-a-real-valued-coordinate" class="anchor"></a>Creating a Spherical ROI around a real-valued coordinate</h2>
<p>To create a spherical ROI centered around a real coordinate in millimeters, we need to first convert the real-valued coordinates to a voxel-based coordinate. Suppose our real-world coordinate is at -50, -28, 10 in coordinate space.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
    rpoint &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">34</span>,<span class="op">-</span><span class="dv">28</span>,<span class="dv">10</span>)</code></pre></div>
<p>Because the function <code>spherical_roi</code> takes a coordinate in <em>voxel units</em>, we need to convert the real-world coordinate (i.e. in millimeter units) to voxel coordinates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    
    vox &lt;-<span class="st"> </span><span class="kw"><a href="../reference/coord_to_grid-methods.html">coord_to_grid</a></span>(vol, rpoint)
    sphere &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spherical_roi.html">spherical_roi</a></span>(vol, vox, <span class="dt">radius=</span><span class="dv">10</span>, <span class="dt">fill=</span><span class="dv">1</span>)
    <span class="kw">dim</span>(<span class="kw"><a href="../reference/coords-methods.html">coords</a></span>(sphere))
<span class="co">#&gt; [1] 85  3</span></code></pre></div>
<p>Now we convert back to real-world coordinates</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    coords &lt;-<span class="st"> </span><span class="kw"><a href="../reference/index_to_coord-methods.html">index_to_coord</a></span>(vol, <span class="kw"><a href="../reference/indices-methods.html">indices</a></span>(sphere))
    center_of_mass &lt;-<span class="st"> </span><span class="kw">colMeans</span>(coords)
    center_of_mass
<span class="co">#&gt; [1] -33.25 -29.25  11.15</span></code></pre></div>
</div>
<div id="converting-an-roi-to-a-sparseneurovol" class="section level2">
<h2 class="hasAnchor">
<a href="#converting-an-roi-to-a-sparseneurovol" class="anchor"></a>Converting an ROI to a SparseNeuroVol</h2>
<p>We may want to convert a region of interest to a NeuroVol instance. But we don’t want to store every value in a dense array. Here we can make use of the <code>SparseNeuroVol</code> class which only stores non-zero values my using a <code><a href="http://www.rdocumentation.org/packages/Matrix/topics/sparseVector">Matrix::sparseVector</a></code> under the hood.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    
    sphere &lt;-<span class="st"> </span><span class="kw"><a href="../reference/spherical_roi.html">spherical_roi</a></span>(vol, <span class="kw">c</span>(<span class="dv">50</span>,<span class="dv">10</span>,<span class="dv">10</span>), <span class="dt">radius=</span><span class="dv">10</span>, <span class="dt">fill=</span><span class="dv">1</span>)
    sphere
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; ROIVol </span>
<span class="co">#&gt;   Size:            85 </span>
<span class="co">#&gt;   Parent Dim:      64 64 25 </span>
<span class="co">#&gt;   Num Data Cols:   1 </span>
<span class="co">#&gt;   Voxel Cen. Mass: 50 10 10</span></code></pre></div>
<p>Now we construct a <code>SparseNeuroVol</code> and fill it with the values stored in the ROI:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    sparsevol &lt;-<span class="st"> </span><span class="kw"><a href="../reference/SparseNeuroVol-class.html">SparseNeuroVol</a></span>(sphere, <span class="kw"><a href="../reference/space-methods.html">space</a></span>(vol),<span class="dt">indices=</span><span class="kw"><a href="../reference/indices-methods.html">indices</a></span>(sphere))
    <span class="kw">sum</span>(sparsevol) <span class="op">==</span><span class="st"> </span><span class="kw">sum</span>(sphere)
<span class="co">#&gt; [1] TRUE</span>
    <span class="kw">all</span>(<span class="kw">dim</span>(sparsevol) <span class="op">==</span><span class="st"> </span><span class="kw">dim</span>(vol))
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
</div>
<div id="carrying-out-simple-searchlight-roi-analyses" class="section level2">
<h2 class="hasAnchor">
<a href="#carrying-out-simple-searchlight-roi-analyses" class="anchor"></a>Carrying out simple “searchlight” ROI analyses</h2>
<p>The so-called roving “searchlight” is often used to perform multivariate statistical analyses in a local neighborhood of each voxel of an image. Several functions in <code>neuroim2</code> can be used to carry out searchlight analyses. These functions produces <code>list</code>s of the <code>ROIVol</code> instances that encapsulate the local neighborhood around each voxel.</p>
<p>Here, we compute the mean value in an exhaustive set of spherical searchlights in an image volume.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(purrr)

## generate a list of searchlight ROIs
slist &lt;-<span class="st"> </span><span class="kw"><a href="../reference/searchlight.html">searchlight</a></span>(vol, <span class="dt">eager=</span><span class="ot">TRUE</span>, <span class="dt">radius=</span><span class="dv">8</span>)

## compute the mean value in each searchlight ROI.
ret &lt;-<span class="st"> </span>slist <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(vol[<span class="kw"><a href="../reference/coords-methods.html">coords</a></span>(.)]))</code></pre></div>
<p>We can also use a “randomized searchlight”, which samples voxels without replacement until all voxels have been included in at least one searchlight.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ret &lt;-<span class="st"> </span>vol <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/random_searchlight.html">random_searchlight</a></span>(<span class="dt">radius=</span><span class="dv">8</span>) <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(vol[<span class="kw"><a href="../reference/coords-methods.html">coords</a></span>(.)]))</code></pre></div>
<p>Another related method involves using a “parcellation” or clustering to define successive regions of interest for an analysis. Here we show how to do this in a similar way as above. First we must define a ‘clustering’ over the voxel space:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
grid &lt;-<span class="st"> </span><span class="kw"><a href="../reference/index_to_coord-methods.html">index_to_coord</a></span>(vol, <span class="kw">which</span>(vol <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>))
kres &lt;-<span class="st"> </span><span class="kw">kmeans</span>(grid, <span class="dt">centers=</span><span class="dv">50</span>, <span class="dt">iter.max=</span><span class="dv">500</span>)</code></pre></div>
<p>Now we create a <code>ClusteredNeuroVol</code> and map the <code>mean</code> function over all clusters:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">kvol &lt;-<span class="st"> </span><span class="kw"><a href="../reference/ClusteredNeuroVol-class.html">ClusteredNeuroVol</a></span>(vol, kres<span class="op">$</span>cluster)
ret &lt;-<span class="st"> </span>vol <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/searchlight.html">clustered_searchlight</a></span>(<span class="dt">cvol=</span>kvol) <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(vol[<span class="kw"><a href="../reference/coords-methods.html">coords</a></span>(.)]))</code></pre></div>
</div>
<div id="working-with-image-patches" class="section level2">
<h2 class="hasAnchor">
<a href="#working-with-image-patches" class="anchor"></a>Working with image patches</h2>
<p>Another type of ROI analysis, similar to the ‘searchlight’, involves working with sets of square or cuboid image “patches”. The <code>patch_set</code> function can be used to generate a set of equally-sized patches that span the image space (or some mask covering the space). The patches are guaranteed to be of equal size. This means that at edges, ‘patches’ will be padded out with the value at the image extremes.</p>
<p>Here we create a patch set consistting of 3 by 3 by 1 square patches that span the image.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
pset &lt;-<span class="st"> </span><span class="kw"><a href="../reference/patch_set-methods.html">patch_set</a></span>(vol, <span class="dt">dims=</span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">1</span>))
<span class="kw">length</span>(pset)
<span class="co">#&gt; [1] 102400</span>
ret &lt;-<span class="st"> </span>pset <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(.))</code></pre></div>
<p>Now we limit patches so that the set of patch centers are within a mask.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
pset &lt;-<span class="st"> </span><span class="kw"><a href="../reference/patch_set-methods.html">patch_set</a></span>(vol, <span class="dt">dims=</span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">1</span>), <span class="dt">mask=</span><span class="kw">as.logical</span>(vol))
<span class="kw">length</span>(pset)
<span class="co">#&gt; [1] 29532</span>
ret &lt;-<span class="st"> </span>pset <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(<span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(.))</code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#regions-of-interest">Regions of interest</a><ul class="nav nav-pills nav-stacked">
<li><a href="#creating-a-spherical-roi">Creating a spherical ROI</a></li>
      <li><a href="#creating-a-spherical-roi-around-a-real-valued-coordinate">Creating a Spherical ROI around a real-valued coordinate</a></li>
      <li><a href="#converting-an-roi-to-a-sparseneurovol">Converting an ROI to a SparseNeuroVol</a></li>
      <li><a href="#carrying-out-simple-searchlight-roi-analyses">Carrying out simple “searchlight” ROI analyses</a></li>
      <li><a href="#working-with-image-patches">Working with image patches</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bradley R Buchsbaum.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
